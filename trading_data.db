import sqlite3
import os
import pandas as pd

def init_db(db_path='trading_data.db'):
    """Cria banco SQLite de forma segura - remove se corrompido"""
    
    # Remove banco corrompido se existir
    if os.path.exists(db_path):
        try:
            temp_conn = sqlite3.connect(db_path)
            temp_conn.execute('SELECT 1')  # Testa validade
            temp_conn.close()
            print(f"‚úÖ Banco '{db_path}' v√°lido encontrado")
        except Exception as e:
            print(f"üóëÔ∏è  Banco corrompido removido: {e}")
            os.remove(db_path)
    
    # Cria banco limpo
    conn = sqlite3.connect(db_path)
    cursor = conn.cursor()
    
    # Tabela hist√≥rico
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS history (
            timestamp DATETIME PRIMARY KEY,
            price REAL,
            rsi REAL
        )
    ''')
    
    # Tabela estado
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS state (
            key TEXT PRIMARY KEY,
            value TEXT
        )
    ''')
    
    conn.commit()
    print(f"‚úÖ Banco '{db_path}' inicializado com sucesso")
    return conn

def save_data(conn, price, rsi):
    """Salva pre√ßo e RSI - idempotente"""
    cursor = conn.cursor()
    cursor.execute(
        'INSERT OR REPLACE INTO history (timestamp, price, rsi) VALUES (CURRENT_TIMESTAMP, ?, ?)', 
        (price, rsi)
    )
    conn.commit()

def get_last_rsi(conn):
    """√öltimo RSI salvo"""
    cursor = conn.cursor()
    cursor.execute('SELECT rsi FROM history ORDER BY timestamp DESC LIMIT 1')
    result = cursor.fetchone()
    return result[0] if result else None

def set_order_state(conn, status):
    """Estado da √∫ltima ordem"""
    cursor = conn.cursor()
    cursor.execute(
        'INSERT OR REPLACE INTO state (key, value) VALUES ("last_order_status", ?)', 
        (status,)
    )
    conn.commit()
